{% extends "core/base.html" %}

{% block title %}{% if object %}QuerySetの編集{% else %}QuerySetの作成{% endif %} - {{ block.super }}{% endblock %}

{% block content %}
    <h1>{% if object %}QuerySetの編集{% else %}QuerySetの作成{% endif %}</h1>

    <style>
        /* カードスタイル */
        .card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 1rem;
        }

        /* CSS Grid レイアウト */
        .form-grid {
            display: grid;
            grid-template-columns: auto 1fr; /* ラベルは自動幅、入力は残り全部 */
            gap: 1rem 1.5rem; /* 行間と列間 */
            align-items: center; /* 垂直方向中央揃え */
        }
        
        .form-group {
            display: contents; /* 親要素のグリッドを継承 */
        }

        .form-grid label {
            font-weight: bold;
            justify-self: end; /* ラベルを右揃えにする */
        }
        
        /* ラジオボタンのラベルを通常のスタイルに */
        #id_source label {
            font-weight: normal;
            justify-self: start;
        }

        /* 入力欄のスタイル */
        .form-grid input[type="text"],
        .form-grid input[type="number"],
        .form-grid select,
        .form-grid textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* paddingを含めてwidth:100%にする */
        }

        /* 2列にまたがる要素 */
        .grid-full-width {
            grid-column: 1 / -1; /* 最初の列から最後の列まで */
        }

        /* キーワードコンテナの共通スタイル */
        .keywords-container {
            border: 1px solid #ccc;
            padding: 0.5rem;
            border-radius: 4px;
         /* max-height: 250px; */
            overflow-y: auto;
            list-style: none;
            padding-left: 0.5rem;
            background-color: #fff; /* 背景色を白に */
        }
        .keywords-container > div, /* JSで生成されるGoogle Newsのキーワード用 */
        .keywords-container #id_cinii_keywords > div, /* Djangoで生成されるCiNiiのキーワード用 */
        .keywords-container #id_arxiv_keywords > div { /* Djangoで生成されるArXivのキーワード用 */
            display: inline-block;
            margin-right: 1rem;
            border: none;
            padding: 0;
        }
        .keywords-container label {
            font-weight: normal;
            justify-self: start;
        }

        /* ボタンのコンテナ */
        .button-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1.5rem;
        }

        /* ボタンの共通スタイル */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-link {
            background-color: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
        }
        .btn-link:hover {
            background-color: #f8f9fa;
            color: #333;
        }

        /* プレビュー結果 */
        #preview-area { margin-top: 2rem; }
        #preview-results ol { list-style: decimal; padding-left: 2rem; }
        #preview-results li { display: list-item; background: none; border: none; padding: 0.25em 0; }
    </style>
    
    <form method="post" id="queryset-form" class="card">
        {% csrf_token %}
        <div class="form-grid">
            {{ form.name.label_tag }} 
            {{ form.name }}

            {{ form.source.label_tag }}
            <div id="id_source">{{ form.source }}</div>

            {{ form.auto_send.label_tag }}
            <div>{{ form.auto_send }}</div>

            {{ form.after_days.label_tag }} 
            {{ form.after_days }}

            {{ form.max_articles.label_tag }} 
            {{ form.max_articles }}

            <!-- Google News Fields -->
            <div id="google-news-fields" class="form-group">
                {{ form.country.label_tag }} 
                {{ form.country }}
                
                {{ form.large_category.label_tag }} 
                {{ form.large_category }}

                <div class="grid-full-width">
                    <label>キーワード</label>
                    <div id="keywords_container" class="keywords-container">
                        <div style="display:none;">
                            {{ form.universal_keywords }}
                            {{ form.current_keywords }}
                            {{ form.related_keywords }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- CiNii Fields -->
            <div id="cinii-fields" class="form-group">
                <div class="grid-full-width">
                    {{ form.cinii_keywords.label_tag }}
                    <div class="keywords-container" id="cinii_keywords_container">
                      {{ form.cinii_keywords }}
                    </div>
                </div>
            </div>

            <!-- arXiv Fields -->
            <div id="arxiv-fields" class="form-group">
                <div class="grid-full-width">
                    {{ form.arxiv_keywords.label_tag }}
                    <div class="keywords-container" id="arxiv_keywords_container">
                      {{ form.arxiv_keywords }}
                    </div>
                </div>
            </div>
            
            <!-- Common Fields -->
            <div class="form-group">
                {{ form.additional_or_keywords.label_tag }}
                {{ form.additional_or_keywords }}

                {{ form.refinement_keywords.label_tag }}
                {{ form.refinement_keywords }}
            </div>
            
            <!-- Buttons -->
            <div class="button-group">
                <button type="submit" class="btn btn-primary">{% if object %}更新する{% else %}作成する{% endif %}</button>
                <button type="button" id="preview-button" class="btn btn-secondary">プレビュー</button>
                <a href="{% url 'subscriptions:queryset_list' %}" class="btn btn-link">キャンセル</a>
            </div>
        </div>
    </form>

    <div id="preview-area" style="display: none;" class="card">
        <h3>プレビュー結果</h3>
        <div id="preview-results"></div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element Selectors ---
    const largeCategorySelect = document.querySelector('#id_large_category');
    const keywordsContainer = document.querySelector('#keywords_container');
    const sourceRadios = document.querySelectorAll('input[name="source"]');
    const googleNewsFields = document.getElementById('google-news-fields');
    const ciniiFields = document.getElementById('cinii-fields');
    const arxivFields = document.getElementById('arxiv-fields');
    const previewButton = document.querySelector('#preview-button');
    const previewArea = document.querySelector('#preview-area');
    const previewResults = document.querySelector('#preview-results');

    // --- Helper function to create a checkbox element ---
    function createCheckbox(name, item, selectedValues = []) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = name;
        checkbox.value = item.id;
        checkbox.id = `id_${name}_${item.id}`;
        if (selectedValues.includes(String(item.id))) {
            checkbox.checked = true;
        }
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.title = item.description || '';
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${item.name}`));
        const wrapper = document.createElement('div');
        wrapper.appendChild(label);
        return wrapper;
    }

    // --- Get selected values for checkboxes ---
    function getSelectedValues(name) {
        const initialSelected = Array.from(document.querySelectorAll(`input[name="${name}"][checked]`));
        return initialSelected.map(cb => cb.value);
    }

    // --- Load all keywords for Google News ---
    function loadAllKeywords() {
        if (!largeCategorySelect || !largeCategorySelect.value) {
            keywordsContainer.innerHTML = '';
            return;
        }
        const largeCategoryId = largeCategorySelect.value;
        const selectedUniversal = getSelectedValues('universal_keywords');
        const selectedCurrent = getSelectedValues('current_keywords');
        const selectedRelated = getSelectedValues('related_keywords');
        
        keywordsContainer.innerHTML = '<p>読み込み中...</p>';
        
        const fetchUniversal = fetch(`/subscriptions/api/universal-keywords/?large_category_id=${largeCategoryId}`).then(res => res.json());
        const fetchCurrent = fetch(`/subscriptions/api/current-keywords/?large_category_id=${largeCategoryId}`).then(res => res.json());
        const fetchRelated = fetch(`/subscriptions/api/related-keywords/?large_category_id=${largeCategoryId}`).then(res => res.json());

        Promise.all([fetchUniversal, fetchCurrent, fetchRelated])
            .then(([universalData, currentData, relatedData]) => {
                let allKeywords = [
                    ...universalData.map(item => ({ ...item, type: 'universal_keywords' })),
                    ...currentData.map(item => ({ ...item, type: 'current_keywords' })),
                    ...relatedData.map(item => ({ ...item, type: 'related_keywords' }))
                ];
                allKeywords.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                
                keywordsContainer.innerHTML = '';
                if (allKeywords.length === 0) {
                    keywordsContainer.innerHTML = '<p>このカテゴリにはキーワードが登録されていません。</p>';
                    return;
                }

                allKeywords.forEach(item => {
                    const selectedMap = {
                        'universal_keywords': selectedUniversal,
                        'current_keywords': selectedCurrent,
                        'related_keywords': selectedRelated
                    };
                    const checkboxElement = createCheckbox(item.type, item, selectedMap[item.type] || []);
                    keywordsContainer.appendChild(checkboxElement);
                });
            })
            .catch(error => {
                keywordsContainer.innerHTML = '<p>キーワードの読み込みに失敗しました。</p>';
                console.error('Error loading keywords:', error);
            });
    }

    // --- Toggle field visibility based on source ---
    function toggleSourceFields(resetValue=true) {
        const selectedSource = document.querySelector('input[name="source"]:checked').value;
        googleNewsFields.style.display = (selectedSource === 'google_news') ? '' : 'none';
        ciniiFields.style.display = (selectedSource === 'cinii') ? '' : 'none';
        arxivFields.style.display = (selectedSource === 'arxiv') ? '' : 'none';

        if (resetValue) {
            console.log("reset")
            document.querySelector('#id_additional_or_keywords').value = "";
            document.querySelector('#id_refinement_keywords').value = "";
            let afterDays = 2;
            if (selectedSource === 'cinii') afterDays = 180;
            if (selectedSource === 'arxiv') afterDays = 30;
            document.querySelector('#id_after_days').value = afterDays;
        }
    }

    // --- クォート対応の分割処理を分離した関数 ---
    function quotedSplit(str) {
        // 正規表現: ダブルクォートで囲まれた部分 or 非空白文字にマッチ
        const regex = /"([^"]*)"|\S+/g;
        const matches = [...str.matchAll(regex)];
        // マッチ結果から、クォート内部 (グループ1) または全体 (グループ0) を抽出
        return matches.map(match => {
            return match[1] !== undefined ? match[1] : match[0];
        });
    }

    // --- Handle Preview Button Click ---
    function handlePreview() {
        const selectedSource = document.querySelector('input[name="source"]:checked').value;
        let finalQuery = '';
        let params = new URLSearchParams({
            source: selectedSource,
            max_articles: document.querySelector('#id_max_articles').value,
        });

        if (selectedSource === 'google_news') {
            if (!largeCategorySelect.value) {
                alert('先に大分類を選択してください。');
                return;
            }
            const parts = [];
            parts.push(largeCategorySelect.options[largeCategorySelect.selectedIndex].text);
            document.querySelectorAll('#keywords_container input[type="checkbox"]:checked').forEach(cb => {
                parts.push(cb.labels[0].textContent.trim());
            });
            const additionalOrKeywords = document.querySelector('#id_additional_or_keywords').value.trim();
            // if (additionalOrKeywords) {
            //  parts.push(...additionalOrKeywords.split(/\s+/).filter(k => k));
            // }
            if (additionalOrKeywords) {
                const k = quotedSplit(additionalOrKeywords);
                parts.push(...k.filter(Boolean)); 
            }
            // let orPart = parts.filter(p => p).join(' OR ');
            let orPart = parts.map(p => p.includes(' ') ? `"${p}"` : p).join(' OR ');
            if (parts.length > 1) orPart = `(${orPart})`;
            const refinementPart = document.querySelector('#id_refinement_keywords').value.trim();
            finalQuery = `${orPart} ${refinementPart}`.trim();

            params.append('q', finalQuery);
            params.append('after_days', document.querySelector('#id_after_days').value);
            params.append('country', document.querySelector('#id_country').value);

        } else if (selectedSource === 'cinii' || selectedSource === 'arxiv') {
            const parts = [];
            const containerId = (selectedSource === 'cinii') ? '#cinii_keywords_container' : '#arxiv_keywords_container';
            
            document.querySelectorAll(`${containerId} input:checked`).forEach(cb => {
                const keyword = cb.labels[0].textContent.trim();
                parts.push(keyword);
            });

            const additionalOrKeywords = document.querySelector('#id_additional_or_keywords').value.trim();
            // if (additionalOrKeywords) {
            //  parts.push(...additionalOrKeywords.split(/\s+/).filter(k => k));
            // }
            if (additionalOrKeywords) {
                const k = quotedSplit(additionalOrKeywords);
                parts.push(...k.filter(Boolean)); 
            }
            // Build query string
            if (selectedSource === 'arxiv') {
                const orPart = parts.map(p => `all:${p.includes(' ') ? `"${p}"` : p}`).join(' OR ');
                const refinementPart = document.querySelector('#id_refinement_keywords').value.trim();
                
                // const refinementParts = refinementPart.split(/\s+/).filter(Boolean).map(term => {
                //     if (term.startsWith('-')) {
                //         let body = term.substring(1);
                //         return `ANDNOT all:${body.includes(' ') ? `"${body}"` : body}`;
                //     }
                //     return `AND all:${term.includes(' ') ? `"${term}"` : term}`;
                // });
                const refinementParts = quotedSplit(refinementPart)
                      .filter(Boolean)
                      .map(term => {
                          // term には、既にクォートが外された状態の単語やフレーズが入っている
                          // 例: 'A', 'B C', '-D E'
                          if (term.startsWith('-')) {
                              let body = term.substring(1); // '-' を取り除く
                              return `ANDNOT all:${body.includes(' ') ? `"${body}"` : body}`;
                          }
                          return `AND all:${term.includes(' ') ? `"${term}"` : term}`;
                      });
                if (orPart && refinementParts.length > 0) {
                    finalQuery = `(${orPart}) ${refinementParts.join(' ')}`;
                } else if (orPart) {
                    finalQuery = orPart;
                } else if (refinementParts.length > 0) {
                    finalQuery = refinementParts.join(' ').replace(/^AND /, ''); // Remove leading AND
                }

            } else { // cinii
                let orPart = parts.map(p => p.includes(' ') ? `"${p}"` : p).join(' OR ');
                if (parts.length > 1) orPart = `(${orPart})`;
                const refinementPart = document.querySelector('#id_refinement_keywords').value.trim();
                finalQuery = `${orPart} ${refinementPart}`.trim();
            }

            params.append('q', finalQuery);
            params.append('after_days', document.querySelector('#id_after_days').value);
        }

        if (!finalQuery) {
            alert('プレビューするキーワードを1つ以上選択・入力してください。');
            return;
        }

        previewArea.style.display = 'block';
        previewResults.innerHTML = '<p>読み込み中...</p>';

        fetch(`/subscriptions/api/news-preview/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    previewResults.innerHTML = `<p>エラー: ${data.error}</p>`;
                    return;
                }
                if (data.articles.length === 0) {
                    previewResults.innerHTML = `<p>「${data.query_str}」に関する記事は見つかりませんでした。</p>`;
                    return;
                }
                let html = `<h3>「${data.query_str}」の検索結果</h3><ol>`;
                data.articles.forEach(article => {
                    html += `
                        <li>
                            <a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a><br>
                            <small>${article.published}</small>
                        </li>
                    `;
                });
                html += '</ol>';
                previewResults.innerHTML = html;
            })
            .catch(error => {
                previewResults.innerHTML = '<p>プレビューの取得中にエラーが発生しました。</p>';
                console.error('Error:', error);
            });
    }

    // --- Event Listeners & Initial Calls ---

    const isAnyRadioEnabled = document.querySelectorAll('input[name="source"]:not([disabled])').length > 0;
    if (isAnyRadioEnabled) {
       sourceRadios.forEach(radio => radio.addEventListener('change', toggleSourceFields));
    }
    if (largeCategorySelect) {
        largeCategorySelect.addEventListener('change', loadAllKeywords);
    }
    if (previewButton) {
        previewButton.addEventListener('click', handlePreview);
    }

    // Initial State Setup
    toggleSourceFields(false);
    if (largeCategorySelect && largeCategorySelect.value && document.querySelector('input[name="source"]:checked').value === 'google_news') {
        loadAllKeywords();
    }
});
</script>
{% endblock %}
