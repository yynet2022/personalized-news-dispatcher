{% extends "core/base.html" %}

{% block title %}{% if object %}QuerySetの編集{% else %}QuerySetの作成{% endif %} - {{ block.super }}{% endblock %}

{% block content %}
    <h1>{% if object %}QuerySetの編集{% else %}QuerySetの作成{% endif %}</h1>

    <style>
        /* チェックボックスのコンテナにスタイルを適用 */
        #id_universal_keywords, #id_current_keywords, #id_related_keywords {
            border: 1px solid #ccc;
            padding: 0.5rem;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            list-style: none; /* Djangoが生成するulの黒丸を消す */
            padding-left: 0.5rem; /* 左のパディングを調整 */
        }

        /* チェックボックスの各項目を横並びにする */
        #id_universal_keywords > div,
        #id_current_keywords > div,
        #id_related_keywords > div {
            display: inline-block; /* 横並びに */
            margin-right: 1rem;   /* 右側に余白 */
            border: none;
            padding: 0;
        }
    </style>
    
    <form method="post" id="queryset-form">
        {% csrf_token %}
        {{ form.as_div }}
        
        <button type="submit">{% if object %}更新する{% else %}作成する{% endif %}</button>
        <button type="button" id="preview-button">プレビュー</button>
        <a href="{% url 'subscriptions:queryset_list' %}" class="button-link">キャンセル</a>
    </form>

    <div id="preview-area" style="display: none;">
        <h3>プレビュー結果</h3>
        <div id="preview-results"></div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const largeCategorySelect = document.querySelector('#id_large_category');
    const universalKeywordsContainer = document.querySelector('#id_universal_keywords');
    const currentKeywordsContainer = document.querySelector('#id_current_keywords');
    const relatedKeywordsContainer = document.querySelector('#id_related_keywords');
    const previewButton = document.querySelector('#preview-button');
    const previewArea = document.querySelector('#preview-area');
    const previewResults = document.querySelector('#preview-results');

    // --- ヘルパー関数: チェックボックスを生成してコンテナに追加 ---
    function createCheckboxes(container, name, data, selectedValues = []) {
        container.innerHTML = '';
        data.forEach(item => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = name;
            checkbox.value = item.id;
            checkbox.id = `id_${name}_${item.id}`;
            if (selectedValues.includes(String(item.id))) {
                checkbox.checked = true;
            }

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.title = item.description || ''; // ホバーで説明を表示
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${item.name}`));
            
            const wrapper = document.createElement('div');
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        });
    }

    // --- 1. 大分類が変更されたら、各キーワードを動的に読み込む ---
    largeCategorySelect.addEventListener('change', function() {
        loadAllKeywords();
    });

    function loadAllKeywords() {
        const largeCategoryId = largeCategorySelect.value;

        // Get selected values before clearing the containers
        const selectedUniversal = getSelectedValues('universal_keywords');
        const selectedCurrent = getSelectedValues('current_keywords');
        const selectedRelated = getSelectedValues('related_keywords');
        
        universalKeywordsContainer.innerHTML = ''; 
        currentKeywordsContainer.innerHTML = '';
        relatedKeywordsContainer.innerHTML = '';

        if (!largeCategoryId) {
            return;
        }

        // Universal Keywords
        fetch(`/subscriptions/api/universal-keywords/?large_category_id=${largeCategoryId}`)
            .then(response => response.json())
            .then(data => {
                createCheckboxes(universalKeywordsContainer, 'universal_keywords', data, selectedUniversal);
            });

        // Current Keywords
        fetch(`/subscriptions/api/current-keywords/?large_category_id=${largeCategoryId}`)
            .then(response => response.json())
            .then(data => {
                createCheckboxes(currentKeywordsContainer, 'current_keywords', data, selectedCurrent);
            });

        // Related Keywords
        fetch(`/subscriptions/api/related-keywords/?large_category_id=${largeCategoryId}`)
            .then(response => response.json())
            .then(data => {
                createCheckboxes(relatedKeywordsContainer, 'related_keywords', data, selectedRelated);
            });
    }
    
    function getSelectedValues(name) {
        return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
    }

    // --- 2. プレビューボタンが押されたら、ニュースを取得して表示 ---
    previewButton.addEventListener('click', function() {
        if (!largeCategorySelect.value) {
            alert('先に大分類を選択してください。');
            return;
        }

        const parts = [];
        const largeCategoryName = largeCategorySelect.options[largeCategorySelect.selectedIndex].text;
        parts.push(largeCategoryName);

        document.querySelectorAll('input[name="universal_keywords"]:checked').forEach(cb => {
            parts.push(cb.labels[0].textContent.trim());
        });
        document.querySelectorAll('input[name="current_keywords"]:checked').forEach(cb => {
            parts.push(cb.labels[0].textContent.trim());
        });
        document.querySelectorAll('input[name="related_keywords"]:checked').forEach(cb => {
            parts.push(cb.labels[0].textContent.trim());
        });

        // OR追加キーワード
        const additionalOrKeywords = document.querySelector('#id_additional_or_keywords').value.trim();
        if (additionalOrKeywords) {
            parts.push(...additionalOrKeywords.split(/\s+/).filter(k => k));
        }

        let orPart = parts.filter(p => p).join(' OR ');
        if (orPart) {
            orPart = `(${orPart})`;
        }

        const refinementPart = document.querySelector('#id_refinement_keywords').value.trim();
        
        let finalQuery = orPart;
        if (refinementPart) {
            if (finalQuery) {
                finalQuery = `${finalQuery} ${refinementPart}`;
            } else {
                finalQuery = refinementPart;
            }
        }

        const afterDays = document.querySelector('#id_after_days').value;
        const maxArticles = document.querySelector('#id_max_articles').value;

        previewArea.style.display = 'block';
        previewResults.innerHTML = '<p>読み込み中...</p>';

        const params = new URLSearchParams({
            q: finalQuery,
            after_days: afterDays,
            max_articles: maxArticles
        });

        fetch(`/subscriptions/api/news-preview/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    previewResults.innerHTML = `<p>エラー: ${data.error}</p>`;
                    return;
                }
                if (data.articles.length === 0) {
                    previewResults.innerHTML = `<p>「${data.query_str}」に関するニュースは見つかりませんでした。</p>`;
                    return;
                }

                let html = `<h3>「${data.query_str}」の検索結果</h3><ol>`;
                data.articles.forEach(article => {
                    html += `
                        <li>
                            <a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a><br>
                            <small>${article.published}</small>
                        </li>
                    `;
                });
                html += '</ol>';
                previewResults.innerHTML = html;
            })
            .catch(error => {
                previewResults.innerHTML = '<p>プレビューの取得中にエラーが発生しました。</p>';
                console.error('Error:', error);
            });
    });


});
</script>
{% endblock %}
